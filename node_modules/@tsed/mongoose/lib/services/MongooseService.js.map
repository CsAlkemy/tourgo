{"version":3,"sources":["services/MongooseService.ts"],"names":[],"mappings":";;;AAAA,yCAAqC;AACrC,qCAAqC;AACrC,+CAAkC;AAGlC,IAAa,eAAe,GAA5B,MAAa,eAAe;IAD5B;QAEE;;;;WAIG;QACK,eAAU,GAAmC,IAAI,GAAG,EAAE,CAAC;IA+DjE,CAAC;IA7DC;;;OAGG;IACG,OAAO,CAAC,EAAU,EAAE,GAAW,EAAE,iBAA6C;;YAClF,IAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE;gBAChB,OAAO,MAAM,IAAI,CAAC,GAAG,CAAC,EAAE,CAAE,CAAC;aAC5B;YAED,mBAAI,CAAC,IAAI,CAAC,8BAA8B,EAAE,EAAE,CAAC,CAAC;YAC9C,mBAAI,CAAC,KAAK,CAAC,QAAQ,GAAG,EAAE,CAAC,CAAC;YAC1B,mBAAI,CAAC,KAAK,CAAC,YAAY,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAC,EAAE,CAAC,CAAC;YAE5D,IAAI;gBACF,MAAM,QAAQ,GAAG,MAAM,QAAQ,CAAC,OAAO,CAAC,GAAG,EAAE,iBAAiB,CAAC,CAAC;gBAChE,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,EAAE,QAAQ,CAAC,CAAC;gBAElC,OAAO,QAAQ,CAAC;aACjB;YAAC,OAAO,EAAE,EAAE;gBACX,0BAA0B;gBAC1B,mBAAI,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;gBACf,0BAA0B;gBAC1B,OAAO,CAAC,IAAI,EAAE,CAAC;aAChB;QACH,CAAC;KAAA;IAED;;;OAGG;IACH,GAAG,CAAC,KAAa,SAAS;QACxB,OAAO,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;IACjC,CAAC;IAED;;;;OAIG;IACH,GAAG,CAAC,KAAa,SAAS;QACxB,OAAO,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;IACjC,CAAC;IAEK,gBAAgB;;YACpB,KAAK,MAAM,QAAQ,IAAI,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE,EAAE;gBAC/C;;;;;;mBAMG;gBACH,IACE,QAAQ,IAAI,IAAI;oBAChB,QAAQ,CAAC,UAAU,IAAI,IAAI;oBAC3B,CAAC,QAAQ,CAAC,UAAU,CAAC,UAAU,KAAK,CAAC,IAAI,QAAQ,CAAC,UAAU,CAAC,UAAU,KAAK,CAAC,CAAC,EAC9E;oBACA,MAAM,QAAQ,CAAC,UAAU,EAAE,CAAC;iBAC7B;aACF;QACH,CAAC;KAAA;CACF,CAAA;AArEY,eAAe;IAD3B,gBAAO,EAAE;GACG,eAAe,CAqE3B;AArEY,0CAAe","file":"MongooseService.js","sourcesContent":["import {Service} from \"@tsed/common\";\nimport * as Mongoose from \"mongoose\";\nimport {$log} from \"ts-log-debug\";\n\n@Service()\nexport class MongooseService {\n  /**\n   *\n   * @type {Map<any, any>}\n   * @private\n   */\n  private _instances: Map<string, Mongoose.Mongoose> = new Map();\n\n  /**\n   *\n   * @returns {Promise<\"mongoose\".Connection>}\n   */\n  async connect(id: string, url: string, connectionOptions: Mongoose.ConnectionOptions): Promise<any> {\n    if (this.has(id)) {\n      return await this.get(id)!;\n    }\n\n    $log.info(`Connect to mongo database: ${id}`);\n    $log.debug(`Url: ${url}`);\n    $log.debug(`options: ${JSON.stringify(connectionOptions)}`);\n\n    try {\n      const mongoose = await Mongoose.connect(url, connectionOptions);\n      this._instances.set(id, mongoose);\n\n      return mongoose;\n    } catch (er) {\n      /* istanbul ignore next */\n      $log.error(er);\n      /* istanbul ignore next */\n      process.exit();\n    }\n  }\n\n  /**\n   *\n   * @returns {\"mongoose\".Connection}\n   */\n  get(id: string = \"default\"): Mongoose.Mongoose | undefined {\n    return this._instances.get(id);\n  }\n\n  /**\n   *\n   * @param {string} id\n   * @returns {boolean}\n   */\n  has(id: string = \"default\"): boolean {\n    return this._instances.has(id);\n  }\n\n  async closeConnections() {\n    for (const instance of this._instances.values()) {\n      /**\n       * Connection ready state\n       * 0 = disconnected\n       * 1 = connected\n       * 2 = connecting\n       * 3 = disconnecting\n       */\n      if (\n        instance != null &&\n        instance.connection != null &&\n        (instance.connection.readyState === 1 || instance.connection.readyState === 2)\n      ) {\n        await instance.disconnect();\n      }\n    }\n  }\n}\n"],"sourceRoot":"../../src"}